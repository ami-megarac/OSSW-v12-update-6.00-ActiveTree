diff -Naur linux_ori/include/net/netfilter/nf_tables.h linux/include/net/netfilter/nf_tables.h
--- linux_ori/include/net/netfilter/nf_tables.h	2023-03-13 17:18:25.000000000 +0800
+++ linux/include/net/netfilter/nf_tables.h	2023-06-27 18:58:28.150674446 +0800
@@ -493,6 +493,7 @@
 };
 
 enum nft_trans_phase;
+void nf_tables_activate_set(const struct nft_ctx *ctx, struct nft_set *set);
 void nf_tables_deactivate_set(const struct nft_ctx *ctx, struct nft_set *set,
 			      struct nft_set_binding *binding,
 			      enum nft_trans_phase phase);
diff -Naur linux_ori/net/netfilter/nf_tables_api.c linux/net/netfilter/nf_tables_api.c
--- linux_ori/net/netfilter/nf_tables_api.c	2023-06-25 22:53:30.972258000 +0800
+++ linux/net/netfilter/nf_tables_api.c	2023-06-27 19:01:03.335297941 +0800
@@ -3909,12 +3909,24 @@
 	}
 }
 
+void nf_tables_activate_set(const struct nft_ctx *ctx, struct nft_set *set)
+{
+	if (nft_set_is_anonymous(set))
+		nft_clear(ctx->net, set);
+
+	set->use++;
+}
+EXPORT_SYMBOL_GPL(nf_tables_activate_set);
+
 void nf_tables_deactivate_set(const struct nft_ctx *ctx, struct nft_set *set,
 			      struct nft_set_binding *binding,
 			      enum nft_trans_phase phase)
 {
 	switch (phase) {
 	case NFT_TRANS_PREPARE:
+		if (nft_set_is_anonymous(set))
+			nft_deactivate_next(ctx->net, set);
+	
 		set->use--;
 		return;
 	case NFT_TRANS_ABORT:
diff -Naur linux_ori/net/netfilter/nft_dynset.c linux/net/netfilter/nft_dynset.c
--- linux_ori/net/netfilter/nft_dynset.c	2023-03-13 17:18:25.000000000 +0800
+++ linux/net/netfilter/nft_dynset.c	2023-06-27 19:02:04.899556277 +0800
@@ -259,7 +259,7 @@
 {
 	struct nft_dynset *priv = nft_expr_priv(expr);
 
-	priv->set->use++;
+	nf_tables_activate_set(ctx, priv->set);
 }
 
 static void nft_dynset_destroy(const struct nft_ctx *ctx,
diff -Naur linux_ori/net/netfilter/nft_lookup.c linux/net/netfilter/nft_lookup.c
--- linux_ori/net/netfilter/nft_lookup.c	2023-03-13 17:18:25.000000000 +0800
+++ linux/net/netfilter/nft_lookup.c	2023-06-27 19:02:00.495537618 +0800
@@ -129,7 +129,7 @@
 {
 	struct nft_lookup *priv = nft_expr_priv(expr);
 
-	priv->set->use++;
+	nf_tables_activate_set(ctx, priv->set);
 }
 
 static void nft_lookup_destroy(const struct nft_ctx *ctx,
diff -Naur linux_ori/net/netfilter/nft_objref.c linux/net/netfilter/nft_objref.c
--- linux_ori/net/netfilter/nft_objref.c	2023-03-13 17:18:25.000000000 +0800
+++ linux/net/netfilter/nft_objref.c	2023-06-27 19:02:28.203655454 +0800
@@ -180,7 +180,7 @@
 {
 	struct nft_objref_map *priv = nft_expr_priv(expr);
 
-	priv->set->use++;
+	nf_tables_activate_set(ctx, priv->set);
 }
 
 static void nft_objref_map_destroy(const struct nft_ctx *ctx,
