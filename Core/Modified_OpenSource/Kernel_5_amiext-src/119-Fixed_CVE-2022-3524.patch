--- linux_patch117/net/ipv6/ipv6_sockglue.c	2022-12-13 13:59:44.902551981 +0800
+++ linux/net/ipv6/ipv6_sockglue.c	2022-12-13 14:21:55.390847731 +0800
@@ -164,6 +164,12 @@
 		rtnl_lock();
 	lock_sock(sk);
 
+	/* Another thread has converted the socket into IPv4 with
+	 * IPV6_ADDRFORM concurrently.
+	 */
+	if (unlikely(sk->sk_family != AF_INET6))
+		goto unlock;
+
 	switch (optname) {
 
 	case IPV6_ADDRFORM:
@@ -942,6 +948,7 @@
 		break;
 	}
 
+unlock:
 	release_sock(sk);
 	if (needs_rtnl)
 		rtnl_unlock();
